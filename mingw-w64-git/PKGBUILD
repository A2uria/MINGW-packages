# Maintainer: Martell Malone <martellmalone@gmail.com>
# Maintainer: Ray Donnelly <mingw.android@gmail.com>

_realname=git

pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=1.9.4
pkgrel=1
pkgdesc="The fast distributed version control system (mingw-w64)"
arch=('i686' 'x86_64')
url="http://git-scm.com/"
license=('GPL2')

makedepends=('python2' 'less' 'openssh' 'patch' 'make' 'tar' 'diffutils'
	'ca-certificates')

depends=("${MINGW_PACKAGE_PREFIX}-curl"
         "${MINGW_PACKAGE_PREFIX}-expat>=2.0"
         "${MINGW_PACKAGE_PREFIX}-openssl"
         "${MINGW_PACKAGE_PREFIX}-pcre"
         "${MINGW_PACKAGE_PREFIX}-tcl"
         "perl-Error"
         "perl>=5.14.0"
         "perl-Authen-SASL"
         "perl-libwww"
         "perl-MIME-tools"
         "perl-Net-SMTP-SSL"
         "perl-TermReadKey")

options=(!libtool strip staticlibs)

_sillyname=$pkgver.msysgit.1

source=("${_realname}"::"git+https://github.com/git-for-windows/git.git#tag=v$_sillyname")

md5sums=('SKIP')

prepare() {

  export PYTHON_PATH=/usr/bin/python2
  cd "$srcdir"/$_realname-$_sillyname

  [ -f compat/win32/dirent-mingw.h ]  && rm -f compat/win32/dirent-mingw.h
  [ -f compat/win32/pthread-mingw.h ] && rm -f compat/win32/pthread-mingw.h

  autoreconf -fi
}

build() {
  export PYTHON_PATH=/usr/bin/python2
  cd "$srcdir"

  [ -d build-${CARCH} ] && rm -rf build-${CARCH}
  cp -rf $_realname-$_sillyname build-${CARCH}
  cd build-${CARCH}

  ./configure \
    --build=${MINGW_CHOST} \
    --host=${MINGW_CHOST} \
    --prefix=${MINGW_PREFIX} \
    --libexecdir=${MINGW_PREFIX} \
    --with-editor=vim \
    --with-shell=/usr/bin/sh \
    --with-perl=/usr/bin/perl \
    --htmldir=${MINGW_PREFIX}/share/doc/git/html \
    --mandir=${MINGW_PREFIX}/share/man \
    --with-curl \
    --with-openssl \
    --with-expat \
    --with-iconv

  make INSTALLDIRS=vendor -j1 all V=1
  make -C contrib/subtree prefix=/usr all V=1
}

package() {
  # winpty-git script to invoke console
  mkdir -p "${pkgdir}${MINGW_PREFIX}/bin"
  _exename="git"
  echo "#!/usr/bin/env bash" > "${pkgdir}${MINGW_PREFIX}/bin/${_exename}"
  echo '/usr/bin/winpty "$( dirname ${BASH_SOURCE[0]} )/'${_exename}'.exe" "$@"' >> "${pkgdir}${MINGW_PREFIX}/bin/${_exename}"

  export PYTHON_PATH=/usr/bin/python2
  cd "$srcdir"/build-${CARCH}
  make INSTALLDIRS=vendor DESTDIR="$pkgdir" install
}
